# BunkerOS Performance Optimization - Kernel Parameters
# /etc/sysctl.d/99-bunkeros-performance.conf
#
# These settings optimize Linux kernel parameters for laptop use with focus on:
# - Desktop responsiveness
# - Battery efficiency
# - Reduced latency
# - SSD/NVMe longevity
#
# Applied automatically at boot via systemd-sysctl
# Manually apply with: sudo sysctl --system

# ===================================================================
# Virtual Memory Management
# ===================================================================

# Reduce swappiness (prefer RAM over swap for better responsiveness)
# Default: 60 | Recommended for desktop: 10
# Lower values mean kernel will avoid swapping unless necessary
vm.swappiness = 10

# Control when kernel writes dirty pages to disk
# dirty_ratio: percentage of RAM that can be filled with dirty pages before forced write
# Default: 20 | Reduced to 10 for better SSD longevity
vm.dirty_ratio = 10

# Start writing dirty pages in background earlier
# Default: 10 | Reduced to 5 for smoother I/O performance
vm.dirty_background_ratio = 5

# Reduce cache pressure to keep more inodes/dentries in memory
# Default: 100 | Lower values improve responsiveness for file operations
vm.vfs_cache_pressure = 50

# Laptop mode - reduce disk writes (applies when on battery)
# Controlled by laptop-mode-tools or power profiles
# vm.laptop_mode = 5

# ===================================================================
# Network Stack Optimization
# ===================================================================

# TCP Fast Open - reduces latency for TCP connections
# 1 = client, 2 = server, 3 = both
net.ipv4.tcp_fastopen = 3

# Increase network buffer sizes for better throughput
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# Increase network device backlog queue
net.core.netdev_max_backlog = 16384

# TCP congestion control - BBR for better performance on WiFi
# Requires kernel module: modprobe tcp_bbr
net.ipv4.tcp_congestion_control = bbr

# Enable TCP window scaling for high-bandwidth networks
net.ipv4.tcp_window_scaling = 1

# ===================================================================
# File System Optimization
# ===================================================================

# Increase inotify limits for better file watching (IDEs, file managers)
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# Increase file handle limits
fs.file-max = 2097152

# ===================================================================
# Kernel Scheduler Tuning (Desktop Responsiveness)
# ===================================================================

# Reduce CPU scheduler wakeup granularity for better desktop feel
# Lower values = more responsive but slightly higher CPU usage
# Default: 1000000 (1ms) | Optimized: 500000 (0.5ms)
kernel.sched_min_granularity_ns = 500000
kernel.sched_wakeup_granularity_ns = 500000

# Increase scheduler latency to reduce context switching overhead
# Default: 6000000 (6ms)
kernel.sched_latency_ns = 4000000

# Autogroup scheduler - better isolation between processes
# Improves interactivity when heavy background tasks are running
kernel.sched_autogroup_enabled = 1

# ===================================================================
# Security (Keep existing security hardening)
# ===================================================================

# Prevent kernel pointer leaks
kernel.kptr_restrict = 1

# Restrict dmesg to root only
kernel.dmesg_restrict = 1

# Disable SysRq except for secure shutdown (useful for laptops)
kernel.sysrq = 176

# ===================================================================
# Power Management Related
# ===================================================================

# NMI watchdog - can be disabled to save power
# Set to 0 to disable (saves ~1W on some systems)
# Uncomment if you want to save power and don't need kernel crash detection
# kernel.nmi_watchdog = 0

# ===================================================================
# SSD/NVMe Specific
# ===================================================================

# Increase readahead for faster sequential reads
# Applied per-device via udev rules, this is the default fallback
vm.page-cluster = 0  # Disable swap readahead (not useful on SSD)

# ===================================================================
# Notes
# ===================================================================
#
# These settings are optimized for:
# - Modern laptops with SSD/NVMe storage
# - WiFi connectivity
# - Desktop workload (browsing, coding, light media)
# - Battery efficiency
#
# To verify applied settings:
#   sysctl vm.swappiness
#   sysctl -a | grep vm.
#
# To apply changes without reboot:
#   sudo sysctl --system
#
# To temporarily test a value:
#   sudo sysctl -w vm.swappiness=10
#
# Created by: BunkerOS
# Last updated: 2025-11-06
