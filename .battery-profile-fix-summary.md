# Battery Profile Feature - Installation Fixes

## Issues Found
When the battery profile feature was pulled from the remote repository, it was missing critical installation steps that were configured manually on the development machine.

## Fixes Applied

### 1. Added CSS Styling to All Themes
**Problem:** The `#custom-battery-profile` CSS rules were missing from all theme files.

**Fixed Files:**
- `waybar/style.css.default` - Added battery-profile CSS
- `themes/tactical/waybar-style.css` - Added battery-profile CSS
- `themes/tactical/waybar-style.css.template` - Already had it
- `themes/everforest/waybar-style.css` - Added battery-profile CSS
- `themes/everforest/waybar-style.css.template` - Added battery-profile CSS
- `themes/gruvbox/waybar-style.css` - Added battery-profile CSS
- `themes/gruvbox/waybar-style.css.template` - Added battery-profile CSS
- `themes/nord/waybar-style.css` - Added battery-profile CSS
- `themes/nord/waybar-style.css.template` - Added battery-profile CSS
- `themes/tokyo-night/waybar-style.css` - Added battery-profile CSS
- `themes/tokyo-night/waybar-style.css.template` - Added battery-profile CSS

### 2. Fixed auto-cpufreq Command Syntax
**Problem:** The battery-profile-menu.sh script was using incorrect command syntax and mode names.

**Fixed in:** `waybar/scripts/battery-profile-menu.sh`
- Changed `--force "$mode"` to `--force="$cmd_mode"`
- Mapped internal modes to auto-cpufreq commands:
  - `auto` → `reset`
  - `power` → `powersave`
  - `balanced` → `powersave`
  - `performance` → `performance`

### 3. Added Sudoers Installation to Setup Script
**Problem:** The sudoers file allowing passwordless power profile switching wasn't being installed.

**Fixed in:** `scripts/install-power-management.sh`
- Added installation of `/etc/sudoers.d/auto-cpufreq`
- Set correct permissions (0440)
- Creates initial `/tmp/auto-cpufreq-mode` state file

## What Now Works

### Automatic Installation
When running `./install.sh`, the battery profile feature is now fully configured:
1. ✅ auto-cpufreq package installed and enabled
2. ✅ Sudoers file installed for passwordless switching
3. ✅ Initial state file created
4. ✅ Waybar scripts automatically symlinked
5. ✅ CSS styling included in default config

### Manual Installation
For existing installations that need the fix:

```bash
# Install sudoers file
sudo cp ~/Projects/bunkeros/systemd/sudoers.d/auto-cpufreq /etc/sudoers.d/
sudo chmod 0440 /etc/sudoers.d/auto-cpufreq

# Create state file
echo "auto" > /tmp/auto-cpufreq-mode

# Update waybar style.css with battery-profile CSS
# (Either re-run setup.sh or manually copy from waybar/style.css.default)

# Reload waybar
pkill waybar && swaymsg exec waybar
```

## Testing
After installation, the battery icon should:
- Display in waybar with battery level and profile icon
- Open power profile menu when clicked
- Switch modes without password prompt
- Update icon and color based on selected profile

## Related Files
- `BATTERY-PROFILES.md` - Feature documentation
- `waybar/scripts/battery-profile-status.sh` - Status display script
- `waybar/scripts/battery-profile-menu.sh` - Profile selection menu
- `systemd/sudoers.d/auto-cpufreq` - Passwordless sudo configuration
